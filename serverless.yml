service: masky
frameworkVersion: '3.40.0'

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'production'}
  region: us-east-1
  environment:
    STAGE: ${self:provider.stage}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameter
          Resource: 
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/masky/${self:provider.stage}/firebase_service_account
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/masky/${self:provider.stage}/twitch_client_id
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/masky/${self:provider.stage}/twitch_client_secret  
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/masky/${self:provider.stage}/stripe_secret_key
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/masky/${self:provider.stage}/stripe_webhook_secret
            - arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/masky/${self:provider.stage}/heygen_api_key
        - Effect: Allow
          Action:
            - kms:Decrypt
          Resource: 
            - "*"
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:PutObjectAcl
            - s3:ListBucket
          Resource: "arn:aws:s3:::masky.net/*"      
  apiGateway:
    shouldStartNameWithService: true
    apiKeys: []  # Disable API key requirement
    minimumCompressionSize: 1024
    binaryMediaTypes:
      - 'multipart/form-data'
      - 'image/*'
      - 'application/pdf'
      - 'application/octet-stream'

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - '!dist/**'
    - '!**/*.log'
    - '!**/*.pyc'
    - '!**/*.md'

plugins:
  - serverless-prune-plugin
  - serverless-offline

custom:
  esbuild:
    bundle: true
    minify: false  # Disable minification for local dev
    sourcemap: true  # Enable sourcemaps for debugging
    target: es2020  # Use ES2020 to preserve class syntax
    format: cjs  # CommonJS format
    platform: node
    concurrency: 2
    external:
      - firebase-admin
      - '@google-cloud/storage'
      - '@google-cloud/firestore'
      - '@google-cloud/common'
      - aws-sdk
    exclude: []
  prune:
    automatic: true
    number: 3
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
    websocketPort: 3003
    noPrependStageInUrl: true
    ignoreJWTSignature: true
    noAuth: true
    # Enable CORS for local development
    cors: true
    # Set environment variables for local development
    environment:
      IS_OFFLINE: "true"
      STAGE: "local"

functions:
  api:
    handler: api/api.handler
    timeout: 300  # 5 minutes timeout for local debugging
    events:
      - http:
          path: api/{proxy+}  # Wildcard path that matches api/* 
          method: ANY        # Allows all HTTP methods
          cors: false  # Disable API Gateway CORS - Lambda handles it
          private: false        # Ensure endpoint is public
          authorizer: null     # Disable AWS authorizer
          authentication: null # Disable AWS authentication
