<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masky - User Profile</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/assets/masky-favicon-32.svg">
    <link rel="apple-touch-icon" href="/assets/masky-favicon-32.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/src/styles/main.css">
    <link rel="stylesheet" href="/src/styles/navigation.css">
    <link rel="stylesheet" href="/src/styles/dashboard.css">
    <style>
        html, body {
            max-width: 100vw;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
        }

        .user-container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 2rem 4rem;
        }

        .user-header {
            display: flex;
            align-items: flex-start;
            gap: 2rem;
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 16px;
        }

        .user-header-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .user-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(192, 132, 252, 0.5);
            margin-bottom: 1rem;
        }

        .user-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .user-header-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .donate-section {
            margin: 0;
            padding: 1.5rem;
            background: rgba(192, 132, 252, 0.1);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 12px;
            text-align: center;
        }

        .donate-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 0.75rem;
        }

        .donate-amounts {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .donate-amount-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .donate-amount-btn:hover {
            background: rgba(192, 132, 252, 0.3);
            transform: translateY(-2px);
        }

        .donate-amount-btn.active {
            background: #c084fc;
            border-color: #c084fc;
        }

        .donate-custom-input {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            width: 160px;
            text-align: center;
        }

        .donate-custom-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .donate-btn {
            padding: 1rem 2rem;
            background: #c084fc;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .donate-btn:hover {
            background: #9333ea;
            transform: translateY(-2px);
        }

        .donate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        .loading-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            padding: 3rem;
        }

        .error-state {
            text-align: center;
            color: #ff6b6b;
            padding: 3rem;
        }

        /* About page styles */
        .about-container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 110px 2rem 4rem;
        }
        .page-header { text-align: center; margin-bottom: 4rem; }
        .page-title { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; font-weight: 900; color: #ffffff; text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); margin-bottom: 1rem; }
        .page-subtitle { font-size: 1.2rem; color: rgba(255, 255, 255, 0.7); }
        .team-section { margin-bottom: 4rem; }
        .team-title { font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 700; color: #c084fc; text-align: center; margin-bottom: 3rem; }
        .profiles-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2.5rem; margin-bottom: 4rem; }
        .profile-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 16px; padding: 2rem; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .profile-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(192, 132, 252, 0.3); }
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; }
        .profile-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(192, 132, 252, 0.5); margin-bottom: 1rem; }
        .profile-name { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700; color: #c084fc; }
        .profile-bio { color: rgba(255, 255, 255, 0.8); line-height: 1.7; margin-bottom: 1.5rem; }
        .profile-link { display: inline-flex; align-items: center; gap: 0.5rem; color: #c084fc; text-decoration: none; font-weight: 600; transition: all 0.3s ease; }
        .profile-link:hover { color: #9333ea; transform: translateX(5px); }
        .profile-link::after { content: '‚Üí'; transition: transform 0.3s ease; }
        .profile-link:hover::after { transform: translateX(5px); }
        .mission-section { text-align: center; margin-bottom: 4rem; }
        .mission-title { font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 700; color: #c084fc; margin-bottom: 2rem; }
        .mission-text { color: rgba(255, 255, 255, 0.8); line-height: 1.8; font-size: 1.1rem; max-width: 800px; margin: 0 auto; }
        .watermark { position: fixed; bottom: 2rem; right: 2rem; opacity: 0.1; z-index: 0; pointer-events: none; }
        .watermark .logo-glow { width: 200px; height: auto; filter: drop-shadow(0 0 20px rgba(192, 132, 252, 0.5)); }

        /* Stats section responsive */
        #userStatsSection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 3rem;
        }

        @media (max-width: 968px) {
            #userStatsSection {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .user-container {
                padding: 100px 1rem 2rem;
            }
            .user-header {
                flex-direction: column;
                align-items: center;
            }
            .user-header-right {
                width: 100%;
            }
            .user-name {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="background-effects">
        <div class="holo-bg"></div>
        <div class="liquid-shape liquid-1"></div>
        <div class="liquid-shape liquid-2"></div>
        <div class="liquid-shape liquid-3"></div>
    </div>

    <!-- Header -->
    <div id="header-container"></div>

    <!-- User Content -->
    <div class="user-container">
        <div id="loadingState" class="loading-state">
            <div style="font-size: 2rem; animation: spin 1s linear infinite;">‚è≥</div>
            <p>Loading user profile...</p>
        </div>

        <div id="errorState" class="error-state" style="display: none;">
            <h2>User Not Found</h2>
            <p>The user you're looking for doesn't exist or hasn't set up their profile yet.</p>
        </div>

        <!-- User Page Config Section (hidden by default) -->
        <div id="userPageConfigContainer" style="display: none;"></div>

        <div id="userContent" style="display: none;">
            <div class="user-header">
                <div class="user-header-left">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <h1 id="userName" class="user-name"></h1>
                    <div id="ownerControls" style="display: none; margin-top: 1rem;">
                        <button class="donate-btn" id="configureUserPageBtn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3);">Configure User Page</button>
                    </div>
                </div>
                <div class="user-header-right">
                    <!-- Credits Display -->
                    <div id="pointsSection" class="donate-section" style="display: none; background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                        <h2 class="donate-title" style="color: #3b82f6;">Your Credits</h2>
                        <div style="text-align: center; margin: 0.5rem 0;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #3b82f6;" id="pointsCount">0</div>
                            <p style="color: rgba(255, 255, 255, 0.8); margin-top: 0.5rem; font-size: 0.9rem;">Credits available for redemptions</p>
                        </div>
                    </div>

                    <!-- Donation Section -->
                    <div class="donate-section">
                        <h2 class="donate-title">Buy Credits</h2>
                        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem; font-size: 0.95rem;">
                            Support this creator and earn credits! You'll receive 1 credit for every dollar donated. Credits can be used for redemptions in their channel. VoiceCert Inc. (our parent company) will handle the payment processing.
                        </p>
                        <div class="donate-amounts">
                            <button class="donate-amount-btn" data-amount="5">$5</button>
                            <button class="donate-amount-btn" data-amount="10">$10</button>
                            <button class="donate-amount-btn" data-amount="25">$25</button>
                            <button class="donate-amount-btn" data-amount="50">$50</button>
                            <button class="donate-amount-btn" data-amount="100">$100</button>
                        </div>
                        <div style="margin-top: 1rem;">
                            <input 
                                type="number" 
                                id="customAmount" 
                                class="donate-custom-input" 
                                placeholder="Custom amount"
                                min="1"
                                step="0.01"
                            >
                        </div>
                        <button id="donateBtn" class="donate-btn">Buy Credits</button>
                    </div>
                </div>
            </div>

            <!-- Three Column Section: Tribe, Avatar Carousel, Top Donors -->
            <div id="userStatsSection" style="display: none;">
                <!-- Tribe Section -->
                <div class="stats-box" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 16px; padding: 1.5rem; min-height: 300px;">
                    <h3 class="stats-title" style="font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 700; color: #c084fc; margin-bottom: 1rem; text-align: center;" id="tribeNameTitle">Tribe</h3>
                    <div id="tribeMembersList" style="max-height: 250px; overflow-y: auto; color: rgba(255, 255, 255, 0.8);">
                        <div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.6);">Loading tribe members...</div>
                    </div>
                </div>

                <!-- Avatar Carousel Section -->
                <div class="stats-box" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 16px; padding: 1.5rem; min-height: 300px;">
                    <h3 class="stats-title" style="font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 700; color: #c084fc; margin-bottom: 1rem; text-align: center;">Avatars</h3>
                    <div id="avatarCarouselContainer" style="width: 100%; height: 250px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; overflow: hidden;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255, 255, 255, 0.6);">Loading avatars...</div>
                    </div>
                </div>

                <!-- Top Donors Section -->
                <div class="stats-box" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 16px; padding: 1.5rem; min-height: 300px;">
                    <h3 class="stats-title" style="font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 700; color: #c084fc; margin-bottom: 1rem; text-align: center;">Top Donors</h3>
                    <div id="topDonorsList" style="max-height: 250px; overflow-y: auto; color: rgba(255, 255, 255, 0.8);">
                        <div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.6);">Loading top donors...</div>
                    </div>
                </div>
            </div>

            <!-- Twitch Login Section (if not logged in) -->
            <div id="twitchLoginSection" class="donate-section" style="display: none; margin-top: 2rem;">
                <h2 class="donate-title">Sign in with Twitch</h2>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">
                    Sign in to check your subscription status and credits
                </p>
                <button id="twitchLoginBtn" class="donate-btn" style="background: #9146FF;">Sign in with Twitch</button>
            </div>

            <!-- Available Redemptions Section -->
            <div id="redemptionsSection" class="donate-section" style="display: none; margin-top: 2rem;">
                <h2 class="donate-title">Available Redemptions</h2>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1.5rem;">
                    Spend your credits on these redemptions!
                </p>
                <div id="redemptionsList" style="display: grid; gap: 1rem;">
                    <!-- Redemptions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- About Page (hidden by default) -->
    <section id="aboutSection" style="display: none;">
        <div class="about-container">
            <div class="page-header">
                <h1 class="page-title">About Us</h1>
                <p class="page-subtitle">Meet the team behind Masky</p>
            </div>

            <div class="team-section">
                <h2 class="team-title">Our Founders</h2>
                <div class="profiles-container">
                    <div class="profile-card">
                        <div class="profile-header">
                            <img src="/assets/charlotte.png" alt="Charlotte" class="profile-image">
                            <h3 class="profile-name">Charlotte</h3>
                        </div>
                        <p class="profile-bio">
                            Started streaming as a Woman Fide Master and recently changing my major from computer science to communications, I founded Masky to embrace the wave of AI coming to online streaming, giving streamers fun ways to enhance the interactivity with their communities.
                        </p>
                        <a href="https://www.twitch.tv/azizana" target="_blank" class="profile-link">Follow on Twitch</a>
                    </div>

                    <div class="profile-card">
                        <div class="profile-header">
                            <img src="/assets/seth.png" alt="Seth" class="profile-image">
                            <h3 class="profile-name">Seth</h3>
                        </div>
                        <p class="profile-bio">
                            As a lifelong developer and gamer, streaming has always been a fun hobby of mine, and interacting with twitch chat and the various game integration overlays, building tools like bazaarplanner for reynad's Bazaar game, I was passionate about creating tools to integrate ai with a community-first goal in mind, bringing us together, creating fun memes and gamifying streams in ways that help us all have fun in new ways.
                        </p>
                        <a href="https://www.twitch.tv/simplystrong" target="_blank" class="profile-link">Follow on Twitch</a>
                    </div>
                </div>
            </div>

            <div class="mission-section">
                <h2 class="mission-title">Our Mission</h2>
                <p class="mission-text">
                    At Masky, we believe that streaming should be more interactive, engaging, and fun. We're building AI-powered tools that help streamers create unique experiences for their communities, bringing together the power of artificial intelligence with the creativity of content creators.
                </p>
            </div>
        </div>
        <div class="watermark">
            <img src="/assets/masky-logo-white.svg" alt="Masky" class="logo-glow">
        </div>
    </section>

    <script type="module">
        import { renderHeader } from '/src/header.js';
        import { config } from '/src/config.js';

        // Render header
        renderHeader('#header-container', { showMembershipLink: false });

        // Get username from path
        function getUsernameFromPath() {
            const path = window.location.pathname;
            // Remove leading slash and any trailing slashes
            const username = path.replace(/^\/|\/$/g, '');
            // If path is empty or contains slashes, it's not a valid username
            if (!username || username.includes('/')) {
                return null;
            }
            return username.toLowerCase();
        }

        let selectedAmount = null;
        let currentUserId = null;
        let currentViewerUserId = null;
        let userPageConfig = null;
        let videoCredits = 0;
        let isSubscriber = false;
        let isTribeMember = false;

        // Initialize donation buttons
        document.querySelectorAll('.donate-amount-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.donate-amount-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedAmount = parseFloat(btn.dataset.amount);
                const customAmountInput = document.getElementById('customAmount');
                if (customAmountInput) {
                    customAmountInput.value = selectedAmount;
                }
                // Trigger donate button click
                const donateBtn = document.getElementById('donateBtn');
                if (donateBtn) {
                    donateBtn.click();
                }
            });
        });

        document.getElementById('customAmount').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            if (value > 0) {
                document.querySelectorAll('.donate-amount-btn').forEach(b => b.classList.remove('active'));
                selectedAmount = value;
            }
        });

        document.getElementById('donateBtn').addEventListener('click', async () => {
            if (!selectedAmount || selectedAmount < 1) {
                alert('Please select or enter a donation amount');
                return;
            }

            if (!currentUserId) {
                alert('User information not loaded');
                return;
            }

            const btn = document.getElementById('donateBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const response = await fetch(`${config.api.baseUrl}/api/donations/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        viewerId: currentViewerUserId || null, // Can be null for anonymous donations
                        amount: selectedAmount,
                        successUrl: `${window.location.origin}${window.location.pathname}?donation=success`,
                        cancelUrl: `${window.location.origin}${window.location.pathname}?donation=cancelled`
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create donation');
                }

                // Redirect to Stripe checkout
                window.location.href = data.url;
            } catch (error) {
                console.error('Donation error:', error);
                alert('Failed to process donation: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Buy Credits';
            }
        });

        // Load user data
        async function loadUserData() {
            const username = getUsernameFromPath();
            
            if (!username) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                return;
            }

            try {
                // Import Firebase
                const { db, collection, query, where, getDocs } = await import('/src/firebase.js');

                // Query user by twitchUsername
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('twitchUsername', '==', username.toLowerCase()));
                const userSnapshot = await getDocs(q);

                if (userSnapshot.empty) {
                    throw new Error('User not found');
                }

                const userDoc = userSnapshot.docs[0];
                const userData = userDoc.data();
                currentUserId = userDoc.id;

                // Update UI
                document.getElementById('userName').textContent = userData.displayName || username;
                if (userData.photoURL) {
                    document.getElementById('userAvatar').src = userData.photoURL;
                } else {
                    document.getElementById('userAvatar').style.display = 'none';
                }

                // Load user page config
                userPageConfig = userData.userPageConfig || {
                    enableDonations: true,
                    customVideoPrice: 5,
                    allowAvatarDisplay: false,
                    tribeName: '',
                    tribeJoinCost: 10,
                    bitsToPointsAmount: 100,
                    monthlyTribeVideos: 5,
                    subscribersJoinTribeFree: false
                };

                // Update UI based on config
                if (!userPageConfig.enableDonations) {
                    const donateSection = document.querySelector('.user-header-right .donate-section');
                    if (donateSection) {
                        donateSection.style.display = 'none';
                    }
                }

            // Check if viewer is logged in (this will also load points)
            checkViewerAuth();
            
            // Load available redemptions after auth check (they will be re-rendered with points after auth completes)
            if (userPageConfig.redemptions && userPageConfig.redemptions.length > 0) {
                loadAvailableRedemptions(userPageConfig.redemptions);
            }
            
            // Check if viewer is the owner and show configure button
            checkIfOwner();
            
            // Load avatars if enabled (for display, login not required to see them)
            if (userPageConfig.allowAvatarDisplay) {
                loadAvatarsForDisplay();
            }

                // Show user stats section
                const userStatsSection = document.getElementById('userStatsSection');
                if (userStatsSection) {
                    userStatsSection.style.display = 'grid';
                } else {
                    console.warn('userStatsSection element not found');
                }

                // Load user stats (tribe, avatars, donors)
                loadUserStats();

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('userContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading user:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
            }
        }


        // Check if viewer is authenticated
        async function checkViewerAuth() {
            try {
                const { getCurrentUser, onAuthChange, signInWithTwitch } = await import('/src/firebase.js');
                const user = getCurrentUser();
                
                if (user) {
                    currentViewerUserId = user.uid;
                    document.getElementById('twitchLoginSection').style.display = 'none';
                    // Check subscription status and load credits
                    await checkSubscriptionAndLoadCredits();
                    // Reload redemptions with updated points
                    if (userPageConfig?.redemptions && userPageConfig.redemptions.length > 0) {
                        await loadAvailableRedemptions(userPageConfig.redemptions);
                    }
                    // Update header with user profile
                    updateHeaderWithUserProfile(user);
                } else {
                    currentViewerUserId = null;
                    // Show Twitch login button
                    document.getElementById('twitchLoginSection').style.display = 'block';
                    document.getElementById('pointsSection').style.display = 'none';
                    // Show hamburger menu
                    showHamburgerMenu();
                    const twitchLoginBtn = document.getElementById('twitchLoginBtn');
                    if (twitchLoginBtn) {
                        twitchLoginBtn.onclick = async () => {
                            try {
                                await signInWithTwitch();
                            } catch (error) {
                                console.error('Twitch login error:', error);
                                alert('Failed to sign in with Twitch. Please try again.');
                            }
                        };
                    }
                }

                // Listen for auth changes
                onAuthChange(async (user) => {
                    if (user) {
                        currentViewerUserId = user.uid;
                        document.getElementById('twitchLoginSection').style.display = 'none';
                        await checkSubscriptionAndLoadCredits();
                        // Reload redemptions with updated points
                        if (userPageConfig?.redemptions && userPageConfig.redemptions.length > 0) {
                            await loadAvailableRedemptions(userPageConfig.redemptions);
                        }
                        updateHeaderWithUserProfile(user);
                    } else {
                        currentViewerUserId = null;
                        document.getElementById('twitchLoginSection').style.display = 'block';
                        document.getElementById('pointsSection').style.display = 'none';
                        showHamburgerMenu();
                    }
                });
            } catch (error) {
                console.error('Error checking viewer auth:', error);
            }
        }

        // Update header to show user profile icon instead of hamburger menu
        async function updateHeaderWithUserProfile(user) {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            if (!mobileMenuBtn) return;

            // Hide hamburger menu
            mobileMenuBtn.style.display = 'none';

            // Get broadcaster name
            let broadcasterName = user.displayName || 'User';
            try {
                const { getBroadcasterInfo } = await import('/src/twitch.js');
                const broadcasterInfo = await getBroadcasterInfo();
                if (broadcasterInfo && broadcasterInfo.login) {
                    broadcasterName = broadcasterInfo.login;
                }
            } catch (error) {
                console.warn('Could not fetch broadcaster info:', error);
            }

            // Check if user profile button already exists
            let userProfileBtn = document.getElementById('userProfileBtn');
            if (!userProfileBtn) {
                // Create user profile button
                userProfileBtn = document.createElement('button');
                userProfileBtn.id = 'userProfileBtn';
                userProfileBtn.className = 'user-profile-btn';
                userProfileBtn.style.cssText = 'background: none; border: none; cursor: pointer; padding: 0; border-radius: 50%; overflow: hidden; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;';
                
                const profileImg = document.createElement('img');
                profileImg.id = 'userProfileImg';
                profileImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 50%;';
                profileImg.alt = 'User Profile';
                userProfileBtn.appendChild(profileImg);

                // Create dropdown menu
                const dropdown = document.createElement('div');
                dropdown.id = 'userProfileDropdown';
                dropdown.className = 'user-profile-dropdown';
                dropdown.style.cssText = 'display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: rgba(20, 20, 20, 0.95); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 8px; padding: 0.5rem; min-width: 150px; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);';

                // Container for button and dropdown
                const container = document.createElement('div');
                container.style.cssText = 'position: relative;';
                container.appendChild(userProfileBtn);
                container.appendChild(dropdown);

                // Insert before nav-links or after logo
                const nav = mobileMenuBtn.closest('nav');
                if (nav) {
                    const navLinks = nav.querySelector('.nav-links');
                    if (navLinks) {
                        navLinks.appendChild(container);
                    } else {
                        nav.appendChild(container);
                    }
                }

                // Toggle dropdown on click
                userProfileBtn.onclick = (e) => {
                    e.stopPropagation();
                    const isVisible = dropdown.style.display === 'block';
                    dropdown.style.display = isVisible ? 'none' : 'block';
                };

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!container.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            }

            // Update dropdown content with broadcaster name
            const dropdown = document.getElementById('userProfileDropdown');
            if (dropdown) {
                dropdown.innerHTML = `
                    <div style="padding: 0.75rem; color: rgba(255, 255, 255, 0.95); font-weight: 600; font-size: 0.95rem; text-align: center;">${broadcasterName}</div>
                    <div style="height: 1px; background: rgba(192, 132, 252, 0.3); margin: 0.25rem 0;"></div>
                    <a href="/" onclick="event.preventDefault(); window.location.href='/?membership=true';" style="display: block; padding: 0.75rem; color: rgba(255, 255, 255, 0.9); text-decoration: none; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(192, 132, 252, 0.2)'" onmouseout="this.style.background='transparent'">Membership</a>
                    <a href="#" onclick="showAbout(); return false;" style="display: block; padding: 0.75rem; color: rgba(255, 255, 255, 0.9); text-decoration: none; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(192, 132, 252, 0.2)'" onmouseout="this.style.background='transparent'">About</a>
                `;
            }

            // Update profile image
            const profileImg = document.getElementById('userProfileImg');
            if (profileImg && user.photoURL) {
                profileImg.src = user.photoURL;
            } else if (profileImg) {
                // Default avatar if no photo
                profileImg.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="%23c084fc"/><text x="20" y="28" font-size="20" text-anchor="middle" fill="white">üë§</text></svg>';
            }
        }

        // Show hamburger menu (when logged out)
        function showHamburgerMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const userProfileBtn = document.getElementById('userProfileBtn');
            if (mobileMenuBtn) {
                mobileMenuBtn.style.display = 'flex';
            }
            if (userProfileBtn) {
                const container = userProfileBtn.closest('div[style*="position: relative"]');
                if (container) {
                    container.style.display = 'none';
                }
            }
        }

        // Calculate total donated
        async function calculateTotalDonated() {
            if (!currentViewerUserId || !currentUserId) return 0;

            try {
                const { db, collection, query, where, getDocs } = await import('/src/firebase.js');
                
                const donationsRef = collection(db, 'donations');
                const donationsQuery = query(
                    donationsRef,
                    where('userId', '==', currentUserId),
                    where('viewerId', '==', currentViewerUserId)
                );
                const donationsSnapshot = await getDocs(donationsQuery);
                
                let totalDonated = 0;
                console.log('[calculateTotalDonated] Found', donationsSnapshot.size, 'donations');
                donationsSnapshot.forEach(doc => {
                    const donation = doc.data();
                    console.log('[calculateTotalDonated] Donation:', {
                        id: doc.id,
                        amount: donation.amount,
                        viewerId: donation.viewerId,
                        userId: donation.userId
                    });
                    if (donation.viewerId === currentViewerUserId) {
                        // Ensure amount is a number (handle potential string storage)
                        const amount = typeof donation.amount === 'number' ? donation.amount : parseFloat(donation.amount || 0);
                        totalDonated += amount || 0;
                    }
                });
                console.log('[calculateTotalDonated] Total donated:', totalDonated);
                return totalDonated;
            } catch (error) {
                console.error('Error calculating total donated:', error);
                return 0;
            }
        }

        // Calculate total spent on redemptions
        async function calculateTotalSpent() {
            if (!currentViewerUserId || !currentUserId) return 0;

            try {
                const { db, collection, query, where, getDocs } = await import('/src/firebase.js');
                
                // Get all redemptions for this user/viewer
                const redemptionsRef = collection(db, 'redemptions');
                const redemptionsQuery = query(
                    redemptionsRef,
                    where('userId', '==', currentUserId),
                    where('viewerId', '==', currentViewerUserId)
                );
                const redemptionsSnapshot = await getDocs(redemptionsQuery);
                
                let totalSpent = 0;
                redemptionsSnapshot.forEach(doc => {
                    const redemption = doc.data();
                    // Ensure creditCost is a number (handle potential string storage)
                    const creditCost = typeof redemption.creditCost === 'number' ? redemption.creditCost : parseFloat(redemption.creditCost || 0);
                    totalSpent += creditCost || 0;
                });
                
                console.log('[calculateTotalSpent] Total spent:', totalSpent);
                return totalSpent;
            } catch (error) {
                console.error('Error calculating total spent:', error);
                return 0;
            }
        }

        // Calculate user points (1 point per dollar donated, minus spent)
        async function calculateUserPoints() {
            if (!currentViewerUserId || !currentUserId) return 0;

            try {
                // Calculate current balance
                const totalDonated = await calculateTotalDonated();
                const totalSpent = await calculateTotalSpent();
                
                // Points = dollars donated - dollars spent
                const points = Math.max(0, totalDonated - totalSpent);
                
                return points;
            } catch (error) {
                console.error('Error calculating user points:', error);
                return 0;
            }
        }

        // Check subscription status and load points
        async function checkSubscriptionAndLoadCredits() {
            if (!currentViewerUserId || !currentUserId) return;

            try {
                const points = await calculateUserPoints();

                // Display points - show whole numbers without decimals if .00
                const pointsDisplay = points % 1 === 0 ? points.toString() : points.toFixed(2);
                document.getElementById('pointsCount').textContent = pointsDisplay;
                document.getElementById('pointsSection').style.display = 'block';
            } catch (error) {
                console.error('Error loading points:', error);
            }
        }
        
        // Load and display available redemptions
        async function loadAvailableRedemptions(redemptions) {
            const container = document.getElementById('redemptionsList');
            if (!container) return;
            
            // Filter redemptions that should be shown
            const availableRedemptions = redemptions.filter(r => r.showInQueue !== false);
            
            if (availableRedemptions.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center;">No redemptions available</p>';
                return;
            }
            
            container.innerHTML = '';
            
            const userPoints = await calculateUserPoints();
            
            availableRedemptions.forEach(redemption => {
                const card = document.createElement('div');
                card.className = 'redemption-card';
                card.style.cssText = 'background: rgba(255,255,255,0.05); border: 1px solid rgba(192,132,252,0.3); border-radius: 12px; padding: 1.5rem;';
                
                // Use small epsilon for floating point comparison
                const epsilon = 0.01;
                const canAfford = userPoints + epsilon >= redemption.creditCost;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <div>
                            <h3 style="color: #c084fc; margin: 0 0 0.5rem 0; font-size: 1.2rem;">${redemption.name || 'Unnamed Redemption'}</h3>
                            ${redemption.description ? `<p style="color: rgba(255,255,255,0.7); margin: 0; font-size: 0.9rem;">${redemption.description}</p>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #c084fc; font-size: 1.5rem; font-weight: bold;">${redemption.creditCost}</div>
                            <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">credits</div>
                        </div>
                    </div>
                    ${redemption.id === 'custom-video' ? `
                        <div id="customVideoForm-${redemption.id}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(192,132,252,0.3);">
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.8);">Video Source:</label>
                                <div class="video-source-selector" style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="videoSource-${redemption.id}" value="url" class="video-source-radio" checked>
                                        <span>URL</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="videoSource-${redemption.id}" value="upload" class="video-source-radio">
                                        <span>Upload file</span>
                                    </label>
                                </div>
                                <div class="video-url-wrapper">
                                    <input type="text" class="video-url-input" placeholder="Enter video URL" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3); border-radius: 8px; color: #fff;">
                                </div>
                                <div class="video-file-wrapper" style="display: none; margin-top: 0.5rem;">
                                    <input type="file" class="video-file-input" accept="video/*" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3); border-radius: 8px; color: #fff;">
                                    <small style="display:block; color: rgba(255,255,255,0.6); margin-top: 0.25rem;">Max size 250MB</small>
                                </div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.8);">Message (optional):</label>
                                <textarea class="video-message-input" placeholder="Add a message" rows="3" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
                            </div>
                        </div>
                    ` : redemption.allowCustomUserString ? `
                        <div style="margin-top: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.8);">${escapeHtml(redemption.customStringDescription || 'Custom Message:')}</label>
                            <input type="text" class="custom-string-input" placeholder="${escapeHtmlAttribute(redemption.customStringDescription || 'Enter your message')}" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3); border-radius: 8px; color: #fff;">
                        </div>
                    ` : ''}
                    <button class="redeem-btn" data-redemption-id="${redemption.id}" ${!canAfford ? 'disabled' : ''} style="width: 100%; padding: 0.75rem; background: ${canAfford ? '#c084fc' : 'rgba(255,255,255,0.1)'}; border: 1px solid ${canAfford ? '#c084fc' : 'rgba(192,132,252,0.3)'}; border-radius: 8px; color: #fff; font-weight: 600; cursor: ${canAfford ? 'pointer' : 'not-allowed'}; margin-top: 1rem; opacity: ${canAfford ? '1' : '0.5'};">
                        ${canAfford ? 'Redeem' : 'Not Enough Credits'}
                    </button>
                `;
                
                // Handle custom video form toggle
                if (redemption.id === 'custom-video') {
                    const redeemBtn = card.querySelector('.redeem-btn');
                    const form = card.querySelector(`#customVideoForm-${redemption.id}`);
                    let formVisible = false;
                    
                    redeemBtn.onclick = () => {
                        if (!canAfford) return;
                        if (!formVisible) {
                            form.style.display = 'block';
                            formVisible = true;
                            redeemBtn.textContent = 'Create Custom Video';
                            
                            // Wire up source selector toggling
                            const urlWrapper = card.querySelector('.video-url-wrapper');
                            const fileWrapper = card.querySelector('.video-file-wrapper');
                            const urlInput = card.querySelector('.video-url-input');
                            const fileInput = card.querySelector('.video-file-input');
                            card.querySelectorAll('.video-source-radio').forEach(r => {
                                r.addEventListener('change', () => {
                                    const val = card.querySelector('.video-source-radio:checked')?.value || 'url';
                                    if (val === 'url') {
                                        urlWrapper.style.display = '';
                                        fileWrapper.style.display = 'none';
                                        if (fileInput) fileInput.value = '';
                                    } else {
                                        urlWrapper.style.display = 'none';
                                        fileWrapper.style.display = '';
                                        if (urlInput) urlInput.value = '';
                                    }
                                });
                            });
                        } else {
                            handleRedemption(redemption, card);
                        }
                    };
                } else {
                    const redeemBtn = card.querySelector('.redeem-btn');
                    redeemBtn.onclick = () => {
                        if (!canAfford) return;
                        handleRedemption(redemption, card);
                    };
                }
                
                container.appendChild(card);
            });
            
            document.getElementById('redemptionsSection').style.display = 'block';
        }
        
        // Handle redemption
        async function handleRedemption(redemption, cardElement) {
            if (!currentViewerUserId) {
                alert('Please sign in to redeem');
                return;
            }
            
            const userPoints = await calculateUserPoints();
            // Use a small epsilon for floating point comparison to handle precision issues
            const epsilon = 0.01;
            if (userPoints + epsilon < redemption.creditCost) {
                alert('Not enough credits!');
                return;
            }
            
            let customString = null;
            let videoUrl = null;
            let videoFile = null;
            let message = null;
            let avatarId = null;
            
            if (redemption.id === 'custom-video') {
                const urlInput = cardElement.querySelector('.video-url-input');
                const fileInput = cardElement.querySelector('.video-file-input');
                const messageInput = cardElement.querySelector('.video-message-input');
                
                videoUrl = urlInput?.value.trim() || null;
                videoFile = fileInput?.files[0] || null;
                message = messageInput?.value.trim() || null;
                
                // Enforce only active source is required
                const selectedSource = cardElement.querySelector('.video-source-radio:checked')?.value || 'url';
                if (selectedSource === 'url') {
                    if (!videoUrl) {
                        alert('Please provide a video URL');
                        return;
                    }
                    const sanitized = sanitizeVideoUrl(videoUrl);
                    if (!sanitized) {
                        alert('The video URL appears invalid or unsafe. Please use an http(s) URL.');
                        return;
                    }
                    videoUrl = sanitized;
                } else {
                    if (!videoFile) {
                        alert('Please upload a video file');
                        return;
                    }
                    const maxBytes = 250 * 1024 * 1024;
                    if (videoFile.size > maxBytes) {
                        alert('Video is too large. Please upload a file under 250MB.');
                        return;
                    }
                    try {
                        videoUrl = await uploadViewerVideoAndGetUrl(currentUserId, currentViewerUserId, videoFile);
                    } catch (e) {
                        console.error('Upload failed:', e);
                        alert('Failed to upload video. Please try again.');
                        return;
                    }
                }
            } else if (redemption.allowCustomUserString) {
                const customInput = cardElement.querySelector('.custom-string-input');
                customString = customInput?.value.trim() || null;
            }
            
            const btn = cardElement.querySelector('.redeem-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                const response = await fetch(`${config.api.baseUrl}/api/redemptions/redeem`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        viewerId: currentViewerUserId,
                        redemptionId: redemption.id,
                        redemptionName: redemption.name,
                        creditCost: redemption.creditCost,
                        customString: customString,
                        videoUrl: videoUrl,
                        message: message
                    })
                });
                
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to redeem');
                }
                
                alert('Redemption successful!');
                
                // Reload points and redemptions
                await checkSubscriptionAndLoadCredits();
                if (userPageConfig?.redemptions) {
                    await loadAvailableRedemptions(userPageConfig.redemptions);
                }
                
                // Reset form if custom video
                if (redemption.id === 'custom-video') {
                    const form = cardElement.querySelector(`#customVideoForm-${redemption.id}`);
                    if (form) {
                        form.style.display = 'none';
                        const urlInput = cardElement.querySelector('.video-url-input');
                        const fileInput = cardElement.querySelector('.video-file-input');
                        const messageInput = cardElement.querySelector('.video-message-input');
                        if (urlInput) urlInput.value = '';
                        if (fileInput) fileInput.value = '';
                        if (messageInput) messageInput.value = '';
                    }
                    btn.textContent = 'Redeem';
                }
            } catch (error) {
                console.error('Error redeeming:', error);
                alert('Failed to redeem: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        // Simple URL sanitizer for video URLs
        function sanitizeVideoUrl(raw) {
            try {
                const trimmed = String(raw).trim();
                const url = new URL(trimmed);
                const protocol = url.protocol.toLowerCase();
                if (protocol !== 'http:' && protocol !== 'https:') {
                    return null;
                }
                // Prevent javascript/data and strip control characters
                return trimmed.replace(/[\u0000-\u001F\u007F]/g, '');
            } catch {
                return null;
            }
        }

        // Escape HTML entities for text content
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Escape HTML attributes
        function escapeHtmlAttribute(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
        }

        async function uploadViewerVideoAndGetUrl(userId, viewerId, file) {
            const { storage, db, collection, addDoc } = await import('/src/firebase.js');
            const { ref, uploadBytes, getDownloadURL } = await import('firebase/storage');
            const safeName = String(file.name || 'video')
                .replace(/[^\w.\-]+/g, '_')
                .slice(0, 100);
            const path = `uploads/${userId}/${viewerId}/${Date.now()}-${safeName}`;
            const storageRef = ref(storage, path);
            await uploadBytes(storageRef, file, {
                contentType: file.type || 'video/mp4',
                cacheControl: 'public,max-age=31536000,immutable'
            });
            const url = await getDownloadURL(storageRef);
            try {
                const uploadsCol = collection(db, 'users', userId, 'uploads');
                await addDoc(uploadsCol, {
                    viewerId: viewerId,
                    path: path,
                    url: url,
                    fileName: file.name || safeName,
                    size: file.size || null,
                    type: file.type || null,
                    createdAt: new Date()
                });
            } catch (e) {
                console.warn('Failed to record upload doc (non-blocking):', e);
            }
            return url;
        }

        // Load avatars for display (public, no auth required)
        async function loadAvatarsForDisplay() {
            if (!userPageConfig?.allowAvatarDisplay || !currentUserId) {
                return;
            }

            try {
                const { db, collection, getDocs } = await import('/src/firebase.js');
                
                // Load user's avatars
                const avatarsRef = collection(db, 'users', currentUserId, 'heygenAvatarGroups');
                const avatarsSnapshot = await getDocs(avatarsRef);
                
                const avatarsGrid = document.getElementById('avatarsGrid');
                const avatarSection = document.getElementById('avatarSelectionSection');
                
                if (avatarsSnapshot.empty) {
                    avatarSection.style.display = 'none';
                    return;
                }

                avatarSection.style.display = 'block';
                avatarsGrid.innerHTML = '';

                avatarsSnapshot.forEach(doc => {
                    const avatarData = doc.data();
                    const avatarCard = document.createElement('div');
                    avatarCard.className = 'avatar-card';
                    avatarCard.dataset.avatarId = doc.id;
                    avatarCard.style.cssText = 'cursor: pointer; padding: 0.5rem; border: 2px solid transparent; border-radius: 8px; text-align: center; transition: all 0.3s ease;';
                    
                    avatarCard.innerHTML = `
                        <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            ${avatarData.avatar_group_name || 'Avatar'}
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">${avatarData.avatar_group_name || 'Avatar'}</div>
                    `;

                    avatarCard.onclick = () => {
                        if (!currentViewerUserId) {
                            alert('Please sign in to select an avatar');
                            return;
                        }
                        document.querySelectorAll('.avatar-card').forEach(card => {
                            card.style.borderColor = 'transparent';
                        });
                        avatarCard.style.borderColor = '#c084fc';
                        selectedAvatarId = doc.id;
                    };

                    avatarsGrid.appendChild(avatarCard);
                });
            } catch (error) {
                console.error('Error loading avatars:', error);
            }
        }

        // Load avatars if enabled (when user is logged in)
        async function loadAvatarsIfEnabled() {
            if (!userPageConfig?.allowAvatarDisplay || !currentUserId || !currentViewerUserId) {
                return;
            }
            // Avatars are already loaded by loadAvatarsForDisplay
            // This function is kept for compatibility
        }


        // Check for donation/video success/cancel
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('donation') === 'success') {
            alert('Thank you for your donation! The creator will be notified.');
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.get('donation') === 'cancelled') {
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.get('video') === 'success') {
            alert('Custom video payment successful! Your video will play on stream soon.');
            window.history.replaceState({}, document.title, window.location.pathname);
            checkSubscriptionAndLoadCredits();
        } else if (urlParams.get('video') === 'cancelled') {
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Load user data on page load
        loadUserData();

        // Load tribe members, avatar carousel, and top donors
        async function loadUserStats() {
            if (!currentUserId) return;

            try {
                await Promise.all([
                    loadTribeMembers(),
                    loadAvatarCarousel(),
                    loadTopDonors()
                ]);
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Load tribe members
        async function loadTribeMembers() {
            if (!currentUserId) return;

            try {
                const { db, collection, query, where, getDocs, doc, getDoc } = await import('/src/firebase.js');
                
                // Get tribe name from user page config
                const tribeName = userPageConfig?.tribeName || 'Tribe';
                const tribeNameTitle = document.getElementById('tribeNameTitle');
                if (tribeNameTitle) {
                    // Replace {streamer} placeholder with actual streamer name
                    const streamerName = document.getElementById('userName')?.textContent || 'Streamer';
                    tribeNameTitle.textContent = tribeName.replace('{streamer}', streamerName);
                }

                // Get all users who have this creator in their tribeMemberships
                const usersRef = collection(db, 'users');
                const allUsersSnapshot = await getDocs(usersRef);
                
                const tribeMembers = [];
                allUsersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    const tribeMemberships = userData.tribeMemberships || {};
                    if (tribeMemberships[currentUserId]) {
                        // This user is a member of the tribe
                        tribeMembers.push({
                            userId: userDoc.id,
                            displayName: userData.displayName || 'Anonymous',
                            twitchUsername: userData.twitchUsername || null
                        });
                    }
                });

                const tribeMembersList = document.getElementById('tribeMembersList');
                if (tribeMembersList) {
                    // Check if current viewer is already a member
                    const isCurrentViewerMember = currentViewerUserId && tribeMembers.some(m => m.userId === currentViewerUserId);
                    
                    if (tribeMembers.length === 0 && !isCurrentViewerMember) {
                        tribeMembersList.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.6);">
                                No tribe members yet
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button id="joinTribeBtn" class="donate-btn" style="background: rgba(192, 132, 252, 0.3); border: 1px solid rgba(192, 132, 252, 0.5);">Join Tribe</button>
                            </div>
                        `;
                    } else {
                        let html = tribeMembers.map(member => `
                            <div style="padding: 0.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                ${member.displayName}${member.twitchUsername ? ` (@${member.twitchUsername})` : ''}
                            </div>
                        `).join('');
                        
                        // Add join button if viewer is not a member
                        if (!isCurrentViewerMember && currentViewerUserId) {
                            html += `
                                <div style="text-align: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                    <button id="joinTribeBtn" class="donate-btn" style="background: rgba(192, 132, 252, 0.3); border: 1px solid rgba(192, 132, 252, 0.5);">Join Tribe</button>
                                </div>
                            `;
                        }
                        
                        tribeMembersList.innerHTML = html;
                    }
                    
                    // Set up join button handler
                    const joinTribeBtn = document.getElementById('joinTribeBtn');
                    if (joinTribeBtn) {
                        joinTribeBtn.onclick = () => handleJoinTribe();
                    }
                }
            } catch (error) {
                console.error('Error loading tribe members:', error);
                const tribeMembersList = document.getElementById('tribeMembersList');
                if (tribeMembersList) {
                    tribeMembersList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: rgba(255, 0, 0, 0.6);">
                            Error loading tribe members
                        </div>
                    `;
                }
            }
        }

        // Handle join tribe button click
        async function handleJoinTribe() {
            if (!currentViewerUserId || !currentUserId) {
                alert('Please log in with Twitch to join the tribe.');
                return;
            }

            try {
                // Disable button while processing
                const joinTribeBtn = document.getElementById('joinTribeBtn');
                if (joinTribeBtn) {
                    joinTribeBtn.disabled = true;
                    joinTribeBtn.textContent = 'Joining...';
                }

                // Call API to join tribe
                const { getCurrentUser } = await import('/src/firebase.js');
                const user = getCurrentUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }

                const idToken = await user.getIdToken();
                const { config } = await import('/src/config.js');
                const response = await fetch(`${config.api.baseUrl}/api/tribe/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    // If server indicates insufficient balance, show a friendly message with details
                    if (result?.error === 'Insufficient balance' && typeof result?.required !== 'undefined') {
                        const req = Number(result.required);
                        const bal = typeof result.balance === 'number' ? result.balance : NaN;
                        const balDisplay = isNaN(bal) ? '' : ` Your current balance is $${bal.toFixed(2)}.`;
                        throw new Error(`You need at least $${req} in credits to join the tribe.${balDisplay}`);
                    }
                    throw new Error(result.error || 'Failed to join tribe');
                }

                // Success - reload tribe members list
                alert(result.isSubscriber ? 'Joined the tribe for free as a subscriber!' : 'Successfully joined the tribe!');
                await loadTribeMembers();
                
                // Reload credits to reflect the spent amount
                await checkSubscriptionAndLoadCredits();

            } catch (error) {
                console.error('Error joining tribe:', error);
                alert(error.message || 'Failed to join tribe. Please try again.');
                
                // Re-enable button
                const joinTribeBtn = document.getElementById('joinTribeBtn');
                if (joinTribeBtn) {
                    joinTribeBtn.disabled = false;
                    joinTribeBtn.textContent = 'Join Tribe';
                }
            }
        }

        // Load avatar carousel
        async function loadAvatarCarousel() {
            if (!currentUserId) return;

            try {
                const { renderAvatarCarousel } = await import('/src/avatarCarousel.js');
                await renderAvatarCarousel('#avatarCarouselContainer', currentUserId);
            } catch (error) {
                console.error('Error loading avatar carousel:', error);
                const container = document.getElementById('avatarCarouselContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255, 255, 255, 0.6);">
                            Error loading avatars
                        </div>
                    `;
                }
            }
        }

        // Load top donors
        async function loadTopDonors() {
            if (!currentUserId) return;

            try {
                const { db, collection, query, where, getDocs, doc, getDoc } = await import('/src/firebase.js');
                
                // Get all donations for this creator
                // Note: We can't orderBy amount directly, so we'll get all and sort in memory
                const donationsRef = collection(db, 'donations');
                const donationsQuery = query(
                    donationsRef,
                    where('userId', '==', currentUserId)
                );
                const donationsSnapshot = await getDocs(donationsQuery);
                
                // Aggregate donations by viewerId
                const donorTotals = {};
                donationsSnapshot.forEach(doc => {
                    const donation = doc.data();
                    const viewerId = donation.viewerId;
                    if (viewerId) {
                        if (!donorTotals[viewerId]) {
                            donorTotals[viewerId] = {
                                viewerId: viewerId,
                                total: 0,
                                donorName: donation.donorName || 'Anonymous'
                            };
                        }
                        donorTotals[viewerId].total += donation.amount || 0;
                    }
                });

                // Sort by total and get top 5
                const topDonors = Object.values(donorTotals)
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 5);

                // Get display names for donors
                for (const donor of topDonors) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', donor.viewerId));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            donor.displayName = userData.displayName || donor.donorName || 'Anonymous';
                            donor.twitchUsername = userData.twitchUsername || null;
                        }
                    } catch (error) {
                        console.warn('Could not load donor info:', error);
                    }
                }

                const topDonorsList = document.getElementById('topDonorsList');
                if (topDonorsList) {
                    if (topDonors.length === 0) {
                        topDonorsList.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.6);">
                                No donors yet
                            </div>
                        `;
                    } else {
                        topDonorsList.innerHTML = topDonors.map((donor, index) => `
                            <div style="padding: 0.75rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                                        ${index + 1}. ${donor.displayName || donor.donorName || 'Anonymous'}${donor.twitchUsername ? ` (@${donor.twitchUsername})` : ''}
                                    </div>
                                </div>
                                <div style="color: #c084fc; font-weight: 600;">
                                    $${donor.total.toFixed(2)}
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading top donors:', error);
                const topDonorsList = document.getElementById('topDonorsList');
                if (topDonorsList) {
                    topDonorsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: rgba(255, 0, 0, 0.6);">
                            Error loading top donors
                        </div>
                    `;
                }
            }
        }

        // Override showAbout function to work on user.html
        window.showAbout = function() {
            const userContainer = document.querySelector('.user-container');
            const aboutSection = document.getElementById('aboutSection');
            
            if (userContainer) userContainer.style.display = 'none';
            if (aboutSection) {
                aboutSection.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // Function to show user content (navigate back from about or config)
        window.showUserContent = function() {
            const userContainer = document.querySelector('.user-container');
            const aboutSection = document.getElementById('aboutSection');
            const userContent = document.getElementById('userContent');
            const configContainer = document.getElementById('userPageConfigContainer');
            
            if (aboutSection) aboutSection.style.display = 'none';
            if (configContainer) configContainer.style.display = 'none';
            if (userContent) userContent.style.display = 'block';
            if (userContainer) userContainer.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Check if current viewer is the owner
        async function checkIfOwner() {
            try {
                const { getCurrentUser } = await import('/src/firebase.js');
                const user = getCurrentUser();
                
                if (user && currentUserId && user.uid === currentUserId) {
                    // Viewer is the owner
                    const ownerControls = document.getElementById('ownerControls');
                    if (ownerControls) {
                        ownerControls.style.display = 'block';
                    }
                    
                    // Set up configure button
                    const configureBtn = document.getElementById('configureUserPageBtn');
                    if (configureBtn) {
                        configureBtn.onclick = () => {
                            showUserPageConfig();
                        };
                    }
                }
            } catch (error) {
                console.error('Error checking if owner:', error);
            }
        }

        // Show user page config
        async function showUserPageConfig() {
            const userContent = document.getElementById('userContent');
            const configContainer = document.getElementById('userPageConfigContainer');
            const aboutSection = document.getElementById('aboutSection');
            
            if (aboutSection) aboutSection.style.display = 'none';
            if (userContent) userContent.style.display = 'none';
            
            if (!configContainer) {
                console.error('Config container not found');
                return;
            }
            
            configContainer.style.display = 'block';
            
            // Import and render config UI
            const { renderUserPageConfig } = await import('/src/configureUserPage.js');
            renderUserPageConfig('#userPageConfigContainer');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Update header logo to navigate back to user page when on about or config page
        setTimeout(() => {
            const logo = document.querySelector('.logo');
            if (logo) {
                const originalOnClick = logo.onclick;
                logo.onclick = function(e) {
                    const aboutSection = document.getElementById('aboutSection');
                    const configContainer = document.getElementById('userPageConfigContainer');
                    if ((aboutSection && aboutSection.style.display === 'block') || 
                        (configContainer && configContainer.style.display === 'block')) {
                        e.preventDefault();
                        window.showUserContent();
                    } else if (originalOnClick) {
                        originalOnClick.call(this, e);
                    } else {
                        window.showUserContent();
                    }
                };
            }
        }, 100);
    </script>
</body>
</html>

