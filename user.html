<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masky - User Profile</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/assets/masky-favicon-32.svg">
    <link rel="apple-touch-icon" href="/assets/masky-favicon-32.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/src/styles/main.css">
    <link rel="stylesheet" href="/src/styles/navigation.css">
    <style>
        html, body {
            max-width: 100vw;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
        }

        .user-container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 2rem 4rem;
        }

        .user-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 16px;
        }

        .user-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(192, 132, 252, 0.5);
            margin: 0 auto 1rem;
            display: block;
        }

        .user-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 0.5rem;
        }

        .donate-section {
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(192, 132, 252, 0.1);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 16px;
            text-align: center;
        }

        .donate-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 1rem;
        }

        .donate-amounts {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .donate-amount-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .donate-amount-btn:hover {
            background: rgba(192, 132, 252, 0.3);
            transform: translateY(-2px);
        }

        .donate-amount-btn.active {
            background: #c084fc;
            border-color: #c084fc;
        }

        .donate-custom-input {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            width: 160px;
            text-align: center;
        }

        .donate-custom-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .donate-btn {
            padding: 1rem 2rem;
            background: #c084fc;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .donate-btn:hover {
            background: #9333ea;
            transform: translateY(-2px);
        }

        .donate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .projects-section {
            margin-top: 3rem;
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 1.5rem;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(192, 132, 252, 0.3);
        }

        .project-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: #c084fc;
            margin-bottom: 0.5rem;
        }

        .project-type {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .project-details {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .project-detail-item {
            margin-bottom: 0.5rem;
        }

        .loading-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            padding: 3rem;
        }

        .error-state {
            text-align: center;
            color: #ff6b6b;
            padding: 3rem;
        }

        /* About page styles */
        .about-container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 110px 2rem 4rem;
        }
        .page-header { text-align: center; margin-bottom: 4rem; }
        .page-title { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; font-weight: 900; color: #ffffff; text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); margin-bottom: 1rem; }
        .page-subtitle { font-size: 1.2rem; color: rgba(255, 255, 255, 0.7); }
        .team-section { margin-bottom: 4rem; }
        .team-title { font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 700; color: #c084fc; text-align: center; margin-bottom: 3rem; }
        .profiles-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2.5rem; margin-bottom: 4rem; }
        .profile-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 16px; padding: 2rem; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .profile-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(192, 132, 252, 0.3); }
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; }
        .profile-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(192, 132, 252, 0.5); margin-bottom: 1rem; }
        .profile-name { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700; color: #c084fc; }
        .profile-bio { color: rgba(255, 255, 255, 0.8); line-height: 1.7; margin-bottom: 1.5rem; }
        .profile-link { display: inline-flex; align-items: center; gap: 0.5rem; color: #c084fc; text-decoration: none; font-weight: 600; transition: all 0.3s ease; }
        .profile-link:hover { color: #9333ea; transform: translateX(5px); }
        .profile-link::after { content: '→'; transition: transform 0.3s ease; }
        .profile-link:hover::after { transform: translateX(5px); }
        .mission-section { text-align: center; margin-bottom: 4rem; }
        .mission-title { font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 700; color: #c084fc; margin-bottom: 2rem; }
        .mission-text { color: rgba(255, 255, 255, 0.8); line-height: 1.8; font-size: 1.1rem; max-width: 800px; margin: 0 auto; }
        .watermark { position: fixed; bottom: 2rem; right: 2rem; opacity: 0.1; z-index: 0; pointer-events: none; }
        .watermark .logo-glow { width: 200px; height: auto; filter: drop-shadow(0 0 20px rgba(192, 132, 252, 0.5)); }

        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 3rem;
        }

        @media (max-width: 768px) {
            .user-container {
                padding: 100px 1rem 2rem;
            }
            .user-name {
                font-size: 2rem;
            }
            .projects-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="background-effects">
        <div class="holo-bg"></div>
        <div class="liquid-shape liquid-1"></div>
        <div class="liquid-shape liquid-2"></div>
        <div class="liquid-shape liquid-3"></div>
    </div>

    <!-- Header -->
    <div id="header-container"></div>

    <!-- User Content -->
    <div class="user-container">
        <div id="loadingState" class="loading-state">
            <div style="font-size: 2rem; animation: spin 1s linear infinite;">⏳</div>
            <p>Loading user profile...</p>
        </div>

        <div id="errorState" class="error-state" style="display: none;">
            <h2>User Not Found</h2>
            <p>The user you're looking for doesn't exist or hasn't set up their profile yet.</p>
        </div>

        <div id="userContent" style="display: none;">
            <div class="user-header">
                <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                <h1 id="userName" class="user-name"></h1>
                <div id="ownerControls" style="display: none; margin-top: 1rem;">
                    <button class="donate-btn" id="configureUserPageBtn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3);">Configure User Page</button>
                </div>
            </div>
            
            <!-- User Page Config Section (hidden by default) -->
            <div id="userPageConfigContainer" style="display: none;"></div>

            <div class="donate-section">
                <h2 class="donate-title">Support This Creator</h2>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">
                    Make a donation to support this creator and trigger a special alert on their stream! You will receive 1 masky credit for use on masky redemptons in their channel for every dollar donated. VoiceCert.Inc will handle the payment processing.
                </p>
                <div class="donate-amounts">
                    <button class="donate-amount-btn" data-amount="5">$5</button>
                    <button class="donate-amount-btn" data-amount="10">$10</button>
                    <button class="donate-amount-btn" data-amount="25">$25</button>
                    <button class="donate-amount-btn" data-amount="50">$50</button>
                    <button class="donate-amount-btn" data-amount="100">$100</button>
                </div>
                <div style="margin-top: 1rem;">
                    <input 
                        type="number" 
                        id="customAmount" 
                        class="donate-custom-input" 
                        placeholder="Custom amount"
                        min="1"
                        step="0.01"
                    >
                    <span style="color: rgba(255, 255, 255, 0.7); margin-left: 0.5rem;">USD</span>
                </div>
                <button id="donateBtn" class="donate-btn">Donate Now</button>
            </div>

            <!-- Twitch Login Section (if not logged in) -->
            <div id="twitchLoginSection" class="donate-section" style="display: none; margin-top: 2rem;">
                <h2 class="donate-title">Sign in with Twitch</h2>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">
                    Sign in to check your subscription status and video credits
                </p>
                <button id="twitchLoginBtn" class="donate-btn" style="background: #9146FF;">Sign in with Twitch</button>
            </div>

            <!-- Video Credits Display -->
            <div id="videoCreditsSection" class="donate-section" style="display: none; margin-top: 2rem; background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                <h2 class="donate-title" style="color: #3b82f6;">Your Video Credits</h2>
                <div style="text-align: center; margin: 1rem 0;">
                    <div style="font-size: 3rem; font-weight: bold; color: #3b82f6;" id="videoCreditsCount">0</div>
                    <p style="color: rgba(255, 255, 255, 0.8); margin-top: 0.5rem;">Custom videos available</p>
                </div>
            </div>

            <!-- Custom Video Creation Section -->
            <div id="customVideoSection" class="donate-section" style="display: none; margin-top: 2rem;">
                <h2 class="donate-title">Create Custom Video</h2>
                <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">
                    Create a custom video that will play on stream! Price: $<span id="customVideoPriceDisplay">5</span>
                </p>

                <!-- Avatar Selection (if enabled) -->
                <div id="avatarSelectionSection" style="display: none; margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.8);">Select Avatar:</label>
                    <div id="avatarsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <!-- Avatars will be loaded here -->
                    </div>
                </div>

                <!-- Video Upload/URL -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.8);">Video URL or Upload:</label>
                    <input 
                        type="text" 
                        id="videoUrlInput" 
                        placeholder="Enter video URL (YouTube, Vimeo, or direct link)"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3); border-radius: 8px; color: #fff; margin-bottom: 0.5rem;"
                    >
                    <input 
                        type="file" 
                        id="videoFileInput" 
                        accept="video/*"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3); border-radius: 8px; color: #fff;"
                    >
                    <small style="color: rgba(255, 255, 255, 0.6); display: block; margin-top: 0.25rem;">Or upload a video file</small>
                </div>

                <!-- Video Message (optional) -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.8);">Message (optional):</label>
                    <textarea 
                        id="videoMessageInput" 
                        placeholder="Add a message to display with your video"
                        rows="3"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(192,132,252,0.3); border-radius: 8px; color: #fff; resize: vertical;"
                    ></textarea>
                </div>

                <button id="createCustomVideoBtn" class="donate-btn">Create Custom Video</button>
            </div>

            <div class="projects-section">
                <h2 class="section-title">Active Projects</h2>
                <div id="projectsGrid" class="projects-grid">
                    <div class="loading-state">
                        <p>Loading projects...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- About Page (hidden by default) -->
    <section id="aboutSection" style="display: none;">
        <div class="about-container">
            <div class="page-header">
                <h1 class="page-title">About Us</h1>
                <p class="page-subtitle">Meet the team behind Masky</p>
            </div>

            <div class="team-section">
                <h2 class="team-title">Our Founders</h2>
                <div class="profiles-container">
                    <div class="profile-card">
                        <div class="profile-header">
                            <img src="/assets/charlotte.png" alt="Charlotte" class="profile-image">
                            <h3 class="profile-name">Charlotte</h3>
                        </div>
                        <p class="profile-bio">
                            Started streaming as a Woman Fide Master and recently changing my major from computer science to communications, I founded Masky to embrace the wave of AI coming to online streaming, giving streamers fun ways to enhance the interactivity with their communities.
                        </p>
                        <a href="https://www.twitch.tv/azizana" target="_blank" class="profile-link">Follow on Twitch</a>
                    </div>

                    <div class="profile-card">
                        <div class="profile-header">
                            <img src="/assets/seth.png" alt="Seth" class="profile-image">
                            <h3 class="profile-name">Seth</h3>
                        </div>
                        <p class="profile-bio">
                            As a lifelong developer and gamer, streaming has always been a fun hobby of mine, and interacting with twitch chat and the various game integration overlays, building tools like bazaarplanner for reynad's Bazaar game, I was passionate about creating tools to integrate ai with a community-first goal in mind, bringing us together, creating fun memes and gamifying streams in ways that help us all have fun in new ways.
                        </p>
                        <a href="https://www.twitch.tv/simplystrong" target="_blank" class="profile-link">Follow on Twitch</a>
                    </div>
                </div>
            </div>

            <div class="mission-section">
                <h2 class="mission-title">Our Mission</h2>
                <p class="mission-text">
                    At Masky, we believe that streaming should be more interactive, engaging, and fun. We're building AI-powered tools that help streamers create unique experiences for their communities, bringing together the power of artificial intelligence with the creativity of content creators.
                </p>
            </div>
        </div>
        <div class="watermark">
            <img src="/assets/masky-logo-white.svg" alt="Masky" class="logo-glow">
        </div>
    </section>

    <script type="module">
        import { renderHeader } from '/src/header.js';
        import { config } from '/src/config.js';

        // Render header
        renderHeader('#header-container', { showMembershipLink: false });

        // Get username from path
        function getUsernameFromPath() {
            const path = window.location.pathname;
            // Remove leading slash and any trailing slashes
            const username = path.replace(/^\/|\/$/g, '');
            // If path is empty or contains slashes, it's not a valid username
            if (!username || username.includes('/')) {
                return null;
            }
            return username.toLowerCase();
        }

        let selectedAmount = null;
        let currentUserId = null;
        let currentViewerUserId = null;
        let userPageConfig = null;
        let videoCredits = 0;
        let isSubscriber = false;
        let isTribeMember = false;

        // Initialize donation buttons
        document.querySelectorAll('.donate-amount-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.donate-amount-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedAmount = parseFloat(btn.dataset.amount);
                document.getElementById('customAmount').value = '';
            });
        });

        document.getElementById('customAmount').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            if (value > 0) {
                document.querySelectorAll('.donate-amount-btn').forEach(b => b.classList.remove('active'));
                selectedAmount = value;
            }
        });

        document.getElementById('donateBtn').addEventListener('click', async () => {
            if (!selectedAmount || selectedAmount < 1) {
                alert('Please select or enter a donation amount');
                return;
            }

            if (!currentUserId) {
                alert('User information not loaded');
                return;
            }

            const btn = document.getElementById('donateBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const response = await fetch(`${config.api.baseUrl}/api/donations/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        viewerId: currentViewerUserId || null, // Can be null for anonymous donations
                        amount: selectedAmount,
                        successUrl: `${window.location.origin}${window.location.pathname}?donation=success`,
                        cancelUrl: `${window.location.origin}${window.location.pathname}?donation=cancelled`
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create donation');
                }

                // Redirect to Stripe checkout
                window.location.href = data.url;
            } catch (error) {
                console.error('Donation error:', error);
                alert('Failed to process donation: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Donate Now';
            }
        });

        // Load user data
        async function loadUserData() {
            const username = getUsernameFromPath();
            
            if (!username) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
                return;
            }

            try {
                // Import Firebase
                const { db, collection, query, where, getDocs } = await import('/src/firebase.js');

                // Query user by twitchUsername
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('twitchUsername', '==', username.toLowerCase()));
                const userSnapshot = await getDocs(q);

                if (userSnapshot.empty) {
                    throw new Error('User not found');
                }

                const userDoc = userSnapshot.docs[0];
                const userData = userDoc.data();
                currentUserId = userDoc.id;

                // Update UI
                document.getElementById('userName').textContent = userData.displayName || username;
                if (userData.photoURL) {
                    document.getElementById('userAvatar').src = userData.photoURL;
                } else {
                    document.getElementById('userAvatar').style.display = 'none';
                }

                // Load user page config
                userPageConfig = userData.userPageConfig || {
                    enableDonations: true,
                    customVideoPrice: 5,
                    allowAvatarDisplay: false,
                    tribeName: '',
                    tribeJoinCost: 10,
                    monthlyTribeVideos: 5,
                    subscribersJoinTribeFree: false
                };

                // Update UI based on config
                if (!userPageConfig.enableDonations) {
                    document.querySelector('.donate-section').style.display = 'none';
                }

                // Show/hide custom video section (always show, but will require login)
                if (userPageConfig.customVideoPrice) {
                    document.getElementById('customVideoSection').style.display = 'block';
                    document.getElementById('customVideoPriceDisplay').textContent = userPageConfig.customVideoPrice;
                }

            // Check if viewer is logged in
            checkViewerAuth();
            
            // Check if viewer is the owner and show configure button
            checkIfOwner();
            
            // Load avatars if enabled (for display, login not required to see them)
            if (userPageConfig.allowAvatarDisplay) {
                loadAvatarsForDisplay();
            }

                // Load projects for this user
                const projectsRef = collection(db, 'projects');
                const projectsQuery = query(
                    projectsRef,
                    where('userId', '==', currentUserId),
                    where('isActive', '==', true)
                );
                const projectsSnapshot = await getDocs(projectsQuery);
                
                const projects = projectsSnapshot.docs.map(doc => ({
                    projectId: doc.id,
                    ...doc.data()
                }));

                if (projects.length > 0) {
                    renderProjects(projects);
                } else {
                    document.getElementById('projectsGrid').innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <p>No active projects yet</p>
                        </div>
                    `;
                }

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('userContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading user:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
            }
        }

        function renderProjects(projects) {
            const grid = document.getElementById('projectsGrid');
            grid.innerHTML = '';

            projects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'project-card';

                let details = [];
                if (project.eventType) {
                    details.push(`<div class="project-detail-item"><strong>Event Type:</strong> ${project.eventType}</div>`);
                }
                if (project.commandTrigger) {
                    details.push(`<div class="project-detail-item"><strong>Chat Command:</strong> !${project.commandTrigger}</div>`);
                }
                if (project.channelPointsMinimumCost !== null && project.channelPointsMinimumCost !== undefined) {
                    details.push(`<div class="project-detail-item"><strong>Channel Points:</strong> ${project.channelPointsMinimumCost} minimum</div>`);
                }
                if (project.channelPointsRewardTitle) {
                    details.push(`<div class="project-detail-item"><strong>Reward Title:</strong> ${project.channelPointsRewardTitle}</div>`);
                }

                card.innerHTML = `
                    <div class="project-name">${project.projectName || 'Unnamed Project'}</div>
                    <div class="project-type">${project.projectType || 'generate'}</div>
                    <div class="project-details">
                        ${details.join('')}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Check if viewer is authenticated
        async function checkViewerAuth() {
            try {
                const { getCurrentUser, onAuthChange, signInWithTwitch } = await import('/src/firebase.js');
                const user = getCurrentUser();
                
                if (user) {
                    currentViewerUserId = user.uid;
                    document.getElementById('twitchLoginSection').style.display = 'none';
                    // Check subscription status and load credits
                    await checkSubscriptionAndLoadCredits();
                } else {
                    currentViewerUserId = null;
                    // Show Twitch login button
                    document.getElementById('twitchLoginSection').style.display = 'block';
                    document.getElementById('videoCreditsSection').style.display = 'none';
                    const twitchLoginBtn = document.getElementById('twitchLoginBtn');
                    if (twitchLoginBtn) {
                        twitchLoginBtn.onclick = async () => {
                            try {
                                await signInWithTwitch();
                            } catch (error) {
                                console.error('Twitch login error:', error);
                                alert('Failed to sign in with Twitch. Please try again.');
                            }
                        };
                    }
                }

                // Listen for auth changes
                onAuthChange(async (user) => {
                    if (user) {
                        currentViewerUserId = user.uid;
                        document.getElementById('twitchLoginSection').style.display = 'none';
                        await checkSubscriptionAndLoadCredits();
                    } else {
                        currentViewerUserId = null;
                        document.getElementById('twitchLoginSection').style.display = 'block';
                        document.getElementById('videoCreditsSection').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Error checking viewer auth:', error);
            }
        }

        // Check subscription status and load video credits
        async function checkSubscriptionAndLoadCredits() {
            if (!currentViewerUserId || !currentUserId) return;

            try {
                const { db, collection, query, where, getDocs, doc, getDoc } = await import('/src/firebase.js');
                
                // Check if viewer is a subscriber
                // This would require checking Twitch API or storing subscription status
                // For now, we'll check donations and calculate credits
                
                // Get all donations from viewer to this creator
                const donationsRef = collection(db, 'donations');
                const donationsQuery = query(
                    donationsRef,
                    where('userId', '==', currentUserId),
                    where('viewerId', '==', currentViewerUserId)
                );
                const donationsSnapshot = await getDocs(donationsQuery);
                
                let totalDonated = 0;
                donationsSnapshot.forEach(doc => {
                    const donation = doc.data();
                    if (donation.viewerId === currentViewerUserId) {
                        totalDonated += donation.amount || 0;
                    }
                });

                // Calculate video credits
                const videoPrice = userPageConfig?.customVideoPrice || 5;
                
                // Get free custom videos (these count as "used" credits, paid videos don't)
                const customVideosRef = collection(db, 'customVideos');
                const freeVideosQuery = query(
                    customVideosRef,
                    where('userId', '==', currentUserId),
                    where('viewerId', '==', currentViewerUserId),
                    where('paid', '==', false)
                );
                const freeVideosSnapshot = await getDocs(freeVideosQuery);
                const freeVideosCount = freeVideosSnapshot.size;
                
                // Calculate credits from donations
                const creditsFromDonations = Math.floor(totalDonated / videoPrice);
                
                // Check tribe membership and free videos
                const viewerUserDoc = await getDoc(doc(db, 'users', currentViewerUserId));
                let remainingFreeVideos = 0;
                
                if (viewerUserDoc.exists()) {
                    const viewerData = viewerUserDoc.data();
                    const tribeMemberships = viewerData.tribeMemberships || {};
                    const membership = tribeMemberships[currentUserId];
                    
                    if (membership) {
                        isTribeMember = true;
                        // Check free videos used this month
                        const freeVideosUsed = membership.freeVideosUsedThisMonth || 0;
                        const monthlyFreeVideos = userPageConfig?.monthlyTribeVideos || 5;
                        remainingFreeVideos = Math.max(0, monthlyFreeVideos - freeVideosUsed);
                    }
                }
                
                // Total credits = donations credits + remaining free videos - free videos already used
                videoCredits = creditsFromDonations + remainingFreeVideos - freeVideosCount;
                videoCredits = Math.max(0, videoCredits); // Don't go negative

                // Display credits
                document.getElementById('videoCreditsCount').textContent = videoCredits;
                document.getElementById('videoCreditsSection').style.display = 'block';
            } catch (error) {
                console.error('Error loading video credits:', error);
            }
        }

        // Load avatars for display (public, no auth required)
        async function loadAvatarsForDisplay() {
            if (!userPageConfig?.allowAvatarDisplay || !currentUserId) {
                return;
            }

            try {
                const { db, collection, getDocs } = await import('/src/firebase.js');
                
                // Load user's avatars
                const avatarsRef = collection(db, 'users', currentUserId, 'heygenAvatarGroups');
                const avatarsSnapshot = await getDocs(avatarsRef);
                
                const avatarsGrid = document.getElementById('avatarsGrid');
                const avatarSection = document.getElementById('avatarSelectionSection');
                
                if (avatarsSnapshot.empty) {
                    avatarSection.style.display = 'none';
                    return;
                }

                avatarSection.style.display = 'block';
                avatarsGrid.innerHTML = '';

                avatarsSnapshot.forEach(doc => {
                    const avatarData = doc.data();
                    const avatarCard = document.createElement('div');
                    avatarCard.className = 'avatar-card';
                    avatarCard.dataset.avatarId = doc.id;
                    avatarCard.style.cssText = 'cursor: pointer; padding: 0.5rem; border: 2px solid transparent; border-radius: 8px; text-align: center; transition: all 0.3s ease;';
                    
                    avatarCard.innerHTML = `
                        <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            ${avatarData.avatar_group_name || 'Avatar'}
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">${avatarData.avatar_group_name || 'Avatar'}</div>
                    `;

                    avatarCard.onclick = () => {
                        if (!currentViewerUserId) {
                            alert('Please sign in to select an avatar');
                            return;
                        }
                        document.querySelectorAll('.avatar-card').forEach(card => {
                            card.style.borderColor = 'transparent';
                        });
                        avatarCard.style.borderColor = '#c084fc';
                        selectedAvatarId = doc.id;
                    };

                    avatarsGrid.appendChild(avatarCard);
                });
            } catch (error) {
                console.error('Error loading avatars:', error);
            }
        }

        // Load avatars if enabled (when user is logged in)
        async function loadAvatarsIfEnabled() {
            if (!userPageConfig?.allowAvatarDisplay || !currentUserId || !currentViewerUserId) {
                return;
            }
            // Avatars are already loaded by loadAvatarsForDisplay
            // This function is kept for compatibility
        }

        let selectedAvatarId = null;

        // Handle custom video creation
        document.getElementById('createCustomVideoBtn').addEventListener('click', async () => {
            if (!currentViewerUserId) {
                alert('Please sign in to create a custom video');
                return;
            }

            const videoUrl = document.getElementById('videoUrlInput').value.trim();
            const videoFile = document.getElementById('videoFileInput').files[0];
            const message = document.getElementById('videoMessageInput').value.trim();

            if (!videoUrl && !videoFile) {
                alert('Please provide a video URL or upload a video file');
                return;
            }

            const btn = document.getElementById('createCustomVideoBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                // If user has credits, create video directly
                // Otherwise, create payment session
                if (videoCredits > 0) {
                    await createCustomVideo(videoUrl, videoFile, message, selectedAvatarId, false);
                } else {
                    // Create payment session
                    const response = await fetch(`${config.api.baseUrl}/api/custom-videos/create-checkout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    body: JSON.stringify({
                        userId: currentUserId,
                        viewerId: currentViewerUserId,
                        videoUrl: videoUrl || (videoFile ? 'UPLOAD_PENDING' : ''),
                        message: message,
                        avatarId: selectedAvatarId,
                        amount: userPageConfig.customVideoPrice,
                        successUrl: `${window.location.origin}${window.location.pathname}?video=success`,
                        cancelUrl: `${window.location.origin}${window.location.pathname}?video=cancelled`
                    })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to create payment session');
                    }

                    // Redirect to Stripe checkout
                    window.location.href = data.url;
                }
            } catch (error) {
                console.error('Error creating custom video:', error);
                alert('Failed to create custom video: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Create Custom Video';
            }
        });

        async function createCustomVideo(videoUrl, videoFile, message, avatarId, paid) {
            // Handle file upload if needed
            let finalVideoUrl = videoUrl;
            if (videoFile && !videoUrl) {
                // TODO: Upload video file to storage and get URL
                // For now, we'll need to handle this on the backend
                alert('Video file upload is not yet implemented. Please provide a video URL.');
                return;
            }

            const response = await fetch(`${config.api.baseUrl}/api/custom-videos/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: currentUserId,
                    viewerId: currentViewerUserId,
                    videoUrl: finalVideoUrl,
                    message: message,
                    avatarId: avatarId,
                    paid: paid
                })
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'Failed to create custom video');
            }

            alert('Custom video created successfully! It will play on stream soon.');
            // Reset form
            document.getElementById('videoUrlInput').value = '';
            document.getElementById('videoFileInput').value = '';
            document.getElementById('videoMessageInput').value = '';
            selectedAvatarId = null;
            document.querySelectorAll('.avatar-card').forEach(card => {
                card.style.borderColor = 'transparent';
            });
            
            // Reload credits
            await checkSubscriptionAndLoadCredits();
        }

        // Check for donation/video success/cancel
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('donation') === 'success') {
            alert('Thank you for your donation! The creator will be notified.');
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.get('donation') === 'cancelled') {
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.get('video') === 'success') {
            alert('Custom video payment successful! Your video will play on stream soon.');
            window.history.replaceState({}, document.title, window.location.pathname);
            checkSubscriptionAndLoadCredits();
        } else if (urlParams.get('video') === 'cancelled') {
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Load user data on page load
        loadUserData();

        // Override showAbout function to work on user.html
        window.showAbout = function() {
            const userContainer = document.querySelector('.user-container');
            const aboutSection = document.getElementById('aboutSection');
            
            if (userContainer) userContainer.style.display = 'none';
            if (aboutSection) {
                aboutSection.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // Function to show user content (navigate back from about or config)
        window.showUserContent = function() {
            const userContainer = document.querySelector('.user-container');
            const aboutSection = document.getElementById('aboutSection');
            const userContent = document.getElementById('userContent');
            const configContainer = document.getElementById('userPageConfigContainer');
            
            if (aboutSection) aboutSection.style.display = 'none';
            if (configContainer) configContainer.style.display = 'none';
            if (userContent) userContent.style.display = 'block';
            if (userContainer) userContainer.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Check if current viewer is the owner
        async function checkIfOwner() {
            try {
                const { getCurrentUser } = await import('/src/firebase.js');
                const user = getCurrentUser();
                
                if (user && currentUserId && user.uid === currentUserId) {
                    // Viewer is the owner
                    const ownerControls = document.getElementById('ownerControls');
                    if (ownerControls) {
                        ownerControls.style.display = 'block';
                    }
                    
                    // Set up configure button
                    const configureBtn = document.getElementById('configureUserPageBtn');
                    if (configureBtn) {
                        configureBtn.onclick = () => {
                            showUserPageConfig();
                        };
                    }
                }
            } catch (error) {
                console.error('Error checking if owner:', error);
            }
        }

        // Show user page config
        async function showUserPageConfig() {
            const userContent = document.getElementById('userContent');
            const configContainer = document.getElementById('userPageConfigContainer');
            const aboutSection = document.getElementById('aboutSection');
            
            if (aboutSection) aboutSection.style.display = 'none';
            if (userContent) userContent.style.display = 'none';
            
            if (!configContainer) {
                console.error('Config container not found');
                return;
            }
            
            configContainer.style.display = 'block';
            
            // Import and render config UI
            const { renderUserPageConfig } = await import('/src/configureUserPage.js');
            renderUserPageConfig('#userPageConfigContainer');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Update header logo to navigate back to user page when on about or config page
        setTimeout(() => {
            const logo = document.querySelector('.logo');
            if (logo) {
                const originalOnClick = logo.onclick;
                logo.onclick = function(e) {
                    const aboutSection = document.getElementById('aboutSection');
                    const configContainer = document.getElementById('userPageConfigContainer');
                    if ((aboutSection && aboutSection.style.display === 'block') || 
                        (configContainer && configContainer.style.display === 'block')) {
                        e.preventDefault();
                        window.showUserContent();
                    } else if (originalOnClick) {
                        originalOnClick.call(this, e);
                    } else {
                        window.showUserContent();
                    }
                };
            }
        }, 100);
    </script>
</body>
</html>

